{"body":"## 概要\n\nサーバー起動時にオプションでトークン認証を有効化し、全APIルート・WebSocket接続にアクセス制御を追加する。CLIでトークンを有効期限付きで発行し、フロントエンドにシンプルなトークン入力画面を提供する。デフォルトは認証なし（後方互換性維持）。\n\nまた、HTTPS直接配信モードを追加し、トークン認証使用時はデフォルトでHTTPS通信のみを許可する。通常起動（認証なし）はHTTPのまま。\n\n## 背景・課題\n\n- ngrokなどのトンネリングサービス利用時に認証なしでAPIが公開されるリスクがある\n- スマホから同一WiFi経由で利用する際にも認証機能がない\n- Issue #179で旧CM_AUTH_TOKEN（クライアント側環境変数に公開されていた問題）を削除し、リバースプロキシ推奨方式に移行したが、リバースプロキシ設定はユーザーの負担が大きい\n- アプリケーション内蔵の軽量な認証機能があれば、リバースプロキシなしでも安全に外部アクセスが可能になる\n- トークン認証をHTTP上で使用するとトークンが平文で流れるため、HTTPS直接配信によるトークン保護が必要\n\n## 提案する解決策\n\n### 認証フロー\n\n```\n1. CLI起動時にトークン生成\n   commandmate start --auth --cert ./cert.pem --key ./key.pem [--auth-expire 48h]\n   → ランダムトークンを生成、ターミナルに表示\n   → サーバーのメモリ上にトークンを保持\n   → HTTPSサーバーとして起動\n\n2. ユーザーがブラウザでアクセス（https://）\n   → 未認証の場合、ログイン画面にリダイレクト\n   → トークン入力画面を表示\n\n3. トークン入力・認証\n   → サーバー側でトークン検証\n   → 成功時にHttpOnly Secure Cookieでセッション管理（有効期限はトークンと連動）\n   → 全APIルート・WebSocket（wss://）で認証チェック\n```\n\n### HTTPS動作モード\n\n| 起動方法 | プロトコル | 認証 | 用途 |\n|----------|-----------|------|------|\n| `commandmate start` | HTTP | なし | ローカル開発（従来通り） |\n| `commandmate start --auth` | HTTP（警告表示） | あり | 証明書なしでの簡易認証 |\n| `commandmate start --auth --allow-http` | HTTP（警告抑制） | あり | HTTP認証を明示的に許可 |\n| `commandmate start --auth --cert ./cert.pem --key ./key.pem` | **HTTPS** | あり | **推奨**: 外部アクセス時 |\n| `commandmate start --https --cert ./cert.pem --key ./key.pem` | HTTPS | なし | 認証なしHTTPS（特殊用途） |\n\n### 証明書の準備（mkcert推奨）\n\nローカル開発・WiFi経由アクセス用の証明書生成にはmkcertを推奨する。\n\n```bash\n# mkcertのインストール\nbrew install mkcert   # macOS\nmkcert -install       # ローカルCAをシステムに登録\n\n# 証明書生成（localhostとローカルIPを含める）\nmkcert localhost 192.168.x.x\n# → localhost+1.pem（証明書）と localhost+1-key.pem（秘密鍵）が生成される\n\n# 起動例\ncommandmate start --auth --cert ./localhost+1.pem --key ./localhost+1-key.pem\n```\n\n### 主要な変更点\n\n- **CLI**: `--auth` オプション追加。`--auth-expire` で有効期限指定（デフォルト24時間）\n- **CLI**: `--https`, `--cert`, `--key`, `--allow-http` オプション追加\n- **HTTPS対応**: server.tsで`https.createServer()`を条件分岐で使用\n- **認証ミドルウェア**: Next.js middleware.tsを新規作成。全APIルート・ページに認証チェック適用\n- **WebSocket認証**: upgrade時にCookieからトークン検証（wss://自動対応済み）\n- **ログイン画面**: トークン入力テキストボックス＋ログインボタンのシンプルUI\n- **トークン管理**: サーバー側はメモリ保持（サーバー停止で失効）、クライアント側はHttpOnly Cookie\n- **ブルートフォース対策**: ログインAPIにIPベースのレート制限を実装\n\n### 設計方針\n\n- `--auth` なしの起動は従来と完全に同じ動作（後方互換性維持）\n- `--auth` 指定時、証明書（`--cert`/`--key`）があればHTTPS起動。なければ警告を出してHTTP起動\n- `--allow-http` で `--auth` 時のHTTP警告を抑制\n- トークンはサーバーメモリに保持し、サーバー停止で自動失効\n- Issue #179の教訓を踏まえ、クライアント側環境変数にトークンを含めない\n- HTTPS時: HttpOnly + Secure + SameSite=Strict Cookie\n- HTTP時: HttpOnly + SameSite=Strict Cookie（Secureなし）\n- Cookieの有効期限はトークンの有効期限に連動（トークンが24hならCookieも24hで失効）\n- クライアント側WebSocket（useWebSocket.ts）は既にwss://自動検出対応済み\n- CSP（next.config.js）は既にws:/wss:両方許可済み\n\n### セキュリティ対策\n\n#### CSRF対策\n\n`SameSite=Strict` Cookieにより、外部サイトからのクロスオリジンリクエストにCookieが送信されないため、CSRFを防止する。追加のCSRFトークンは不要と判断する。\n\n**根拠**:\n- `SameSite=Strict` は最も厳格なSameSiteポリシーであり、異なるオリジンからのリクエストにはCookieが一切付与されない\n- ログインAPI（`POST /api/auth/login`）はJSONボディでトークン文字列を送信する形式のため、攻撃者がトークンを知らない限りCSRFは成立しない\n- 全APIがJSONベースのため、HTMLフォームによるクロスオリジンPOST攻撃のリスクも低い\n\n#### ブルートフォース対策\n\nログインAPI（`POST /api/auth/login`）にIPベースのレート制限を実装し、トークンの総当たり攻撃を防止する。\n\n**方針**:\n- IPアドレスごとにログイン試行回数をメモリ上でカウント（Map管理）\n- 一定回数（例: 5回）の認証失敗後、一定時間（例: 15分）そのIPからのログイン試行をブロック\n- ブロック中は `429 Too Many Requests` を返却\n- レート制限状態はサーバーメモリ上で管理（サーバー再起動でリセット）\n- ログイン画面にも残り試行回数やロックアウト中のメッセージを表示\n\n## 実装タスク\n\n### トークン認証\n\n- [ ] トークン生成ユーティリティの実装（`src/lib/auth.ts`）\n  - ランダムトークン生成（crypto.randomBytes）\n  - 有効期限管理（メモリ上）\n  - トークン検証関数\n- [ ] CLIオプション追加（`src/cli/commands/start.ts`）\n  - `--auth` フラグ\n  - `--auth-expire <duration>` オプション（デフォルト24h）\n  - 起動時にトークンをターミナル表示\n- [ ] Next.js認証ミドルウェアの実装（`src/middleware.ts`新規作成）\n  - Cookie/Authorizationヘッダーからトークン取得\n  - 未認証時はログインページにリダイレクト\n  - `/api/auth/*` と静的リソースは認証除外\n- [ ] ログインAPI実装（`src/app/api/auth/login/route.ts`新規作成）\n  - トークン検証\n  - HttpOnly Cookie設定（HTTPS時はSecure属性付与、有効期限はトークンの残り有効期限と連動）\n- [ ] ログアウトAPI実装（`src/app/api/auth/logout/route.ts`新規作成）\n  - Cookie削除\n- [ ] ログイン画面の実装（`src/app/login/page.tsx`新規作成）\n  - トークン入力テキストボックス\n  - ログインボタン\n  - エラー表示（残り試行回数、ロックアウト中メッセージを含む）\n  - i18n対応\n- [ ] WebSocket認証チェック追加（`src/lib/ws-server.ts`）\n  - connection時にCookieからトークン検証\n  - 認証失敗時は接続拒否\n\n### ブルートフォース対策\n\n- [ ] レート制限ユーティリティの実装（`src/lib/auth.ts` 内、またはrate-limiter専用モジュール）\n  - IPアドレスベースの試行回数カウント（Mapで管理）\n  - 失敗回数上限（デフォルト: 5回）\n  - ロックアウト時間（デフォルト: 15分）\n  - ロックアウト中は `429 Too Many Requests` レスポンス\n  - 認証成功時にカウントリセット\n  - 古いエントリの自動クリーンアップ（メモリリーク防止）\n- [ ] ログインAPIにレート制限を組み込み（`src/app/api/auth/login/route.ts`）\n  - 認証チェック前にレート制限チェック\n  - レスポンスに `Retry-After` ヘッダーを含める\n- [ ] ログイン画面にレート制限状態を表示（`src/app/login/page.tsx`）\n  - 429レスポンス時のロックアウトメッセージ表示\n  - 残り待機時間の表示\n\n### HTTPS対応\n\n- [ ] server.tsのHTTPS対応（`server.ts`）\n  - `https.createServer()` による条件分岐サーバー作成\n  - 証明書ファイル読み込み（fs.readFileSync）\n  - 証明書パスのバリデーション（存在確認、パストラバーサル防止）\n- [ ] CLIオプション追加（`src/cli/commands/start.ts`）\n  - `--https` フラグ（認証なしHTTPS用）\n  - `--cert <path>` 証明書ファイルパス\n  - `--key <path>` 秘密鍵ファイルパス\n  - `--allow-http` フラグ（`--auth`時のHTTP警告抑制）\n  - `--auth`指定時に証明書未設定の場合の警告メッセージ（mkcertによる生成コマンド例を含む）\n    ```\n    WARNING: --auth is enabled without HTTPS. Token will be sent in plaintext.\n    To enable HTTPS, generate certificates with mkcert:\n      brew install mkcert && mkcert -install\n      mkcert localhost 192.168.x.x\n      commandmate start --auth --cert ./localhost+1.pem --key ./localhost+1-key.pem\n    To suppress this warning: --allow-http\n    ```\n- [ ] 環境変数追加（`src/lib/env.ts`, `src/cli/utils/env-setup.ts`）\n  - `CM_HTTPS_CERT` / `CM_HTTPS_KEY` 環境変数対応\n  - 認証・HTTPS状態をサーバー内で共有する仕組み\n\n### ドキュメント\n\n- [ ] セキュリティガイド更新（`docs/security-guide.md`）\n  - トークン認証＋HTTPSの使用方法（クイックスタート形式）\n  - **macOS環境でのmkcert手順**\n    - `brew install mkcert && mkcert -install`\n    - `mkcert localhost 192.168.x.x` でローカルIP含む証明書生成\n    - 同一マシンのブラウザから即座に利用可能\n  - **Linux（Ubuntuサーバー等）環境でのmkcert手順**\n    - mkcertインストール方法（apt / go install / バイナリ直接配置）\n    - `mkcert -install && mkcert localhost <サーバーIP>` で証明書生成\n    - **CA証明書の配布手順**: サーバーで生成したCAを別デバイスのブラウザに信頼させる手順\n      - `mkcert -CAROOT` でrootCA.pemの場所を確認\n      - rootCA.pemをクライアント端末に転送（scp等）\n      - PC: ブラウザ/OSの証明書ストアにインポート\n      - スマホ: プロファイルインストール（iOS）/ 証明書インストール（Android）\n    - CA配布が困難な場合はOpenSSL自己署名証明書（ブラウザ警告あり）を代替として案内\n  - **OpenSSLによる自己署名証明書の手順**（mkcertが使えない環境向け）\n    - `openssl req -x509 -newkey rsa:2048 ...` コマンド例\n    - ブラウザ警告が出る旨の注意書き\n  - **Let's Encrypt証明書の手順**（ドメインを持つ公開サーバー向け、参考情報）\n  - 証明書ファイルの管理上の注意（.gitignoreへの追加、パーミッション600推奨）\n\n## 受入条件\n\n### 後方互換性\n- [ ] `commandmate start` で認証なし・HTTPで起動でき、従来と同じ動作をすること\n\n### トークン認証\n- [ ] `commandmate start --auth` で認証有効のサーバーが起動し、トークンがターミナルに表示されること\n- [ ] `--auth-expire 48h` で有効期限を指定でき、デフォルトは24時間であること\n- [ ] 未認証時にログイン画面が表示されること\n- [ ] 正しいトークンでログインでき、Cookieが設定されること\n- [ ] 不正なトークンでログインが拒否されること\n- [ ] 認証済みの場合、全APIルートにアクセスできること\n- [ ] 認証済みの場合、WebSocket接続が成功すること\n- [ ] 未認証の場合、APIルートが401を返すこと\n- [ ] 未認証の場合、WebSocket接続が拒否されること\n- [ ] サーバー停止でトークンが失効すること\n- [ ] Cookieの有効期限がトークンの残り有効期限と一致すること（トークン残り12hならCookieも12hで失効）\n\n### セキュリティ\n- [ ] CookieにSameSite=Strict属性が設定されていること（CSRF対策）\n- [ ] ログイン失敗を5回繰り返すと、そのIPからのログインが15分間ブロックされること（ブルートフォース対策）\n- [ ] ブロック中にログインを試みると429ステータスが返却されること\n- [ ] 認証成功後に失敗カウントがリセットされること\n- [ ] ログイン画面にロックアウト状態が表示されること\n\n### HTTPS\n- [ ] `--auth` 指定時に `--cert`/`--key` がない場合、mkcertコマンド例を含む警告メッセージが表示されHTTPで起動すること\n- [ ] `--auth --allow-http` 指定時に警告が抑制されること\n- [ ] `--auth --cert ./cert.pem --key ./key.pem` でHTTPSサーバーとして起動すること\n- [ ] `--https --cert ./cert.pem --key ./key.pem` で認証なしHTTPSサーバーとして起動すること\n- [ ] HTTPS起動時にWebSocketがwss://で接続できること\n- [ ] HTTPS起動時にCookieにSecure属性が付与されること\n- [ ] 証明書ファイルが存在しない場合、エラーメッセージが表示されること\n\n### ドキュメント\n- [ ] セキュリティガイドにmkcertによる証明書生成手順が記載されていること（macOS / Linux両方）\n- [ ] セキュリティガイドにLinuxサーバー環境でのCA証明書配布手順が記載されていること\n- [ ] セキュリティガイドにトークン認証＋HTTPSのクイックスタート手順が記載されていること\n- [ ] セキュリティガイドにmkcert以外の代替手段（OpenSSL、Let's Encrypt）が記載されていること\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `server.ts` | HTTP/HTTPS条件分岐サーバー作成、証明書読み込み |\n| `src/middleware.ts` | 新規作成: 認証ミドルウェア |\n| `src/lib/auth.ts` | 新規作成: トークン生成・検証・レート制限ユーティリティ |\n| `src/app/api/auth/login/route.ts` | 新規作成: ログインAPI（Secure Cookie対応、レート制限） |\n| `src/app/api/auth/logout/route.ts` | 新規作成: ログアウトAPI |\n| `src/app/login/page.tsx` | 新規作成: ログイン画面（レート制限状態表示対応） |\n| `src/cli/commands/start.ts` | `--auth`, `--auth-expire`, `--https`, `--cert`, `--key`, `--allow-http` オプション追加 |\n| `src/cli/types/index.ts` | StartOptions型に認証・HTTPSオプション追加 |\n| `src/lib/ws-server.ts` | WebSocket接続時の認証チェック追加 |\n| `src/lib/env.ts` | 認証・HTTPS関連の状態管理追加 |\n| `src/cli/utils/env-setup.ts` | `CM_HTTPS_CERT`, `CM_HTTPS_KEY` 環境変数対応 |\n| `docs/security-guide.md` | トークン認証＋HTTPS使用方法、macOS/Linux別mkcert手順、CA配布手順、代替手段追記 |\n| `.env.example` | 認証・HTTPS関連の設定例追記 |\n\n### 関連コンポーネント\n\n- CLIモジュール（起動フロー）\n- server.ts（HTTP/HTTPSサーバー作成）\n- Next.js ミドルウェア（リクエストフィルタ）\n- WebSocketサーバー（接続認証、wss://対応）\n- フロントエンド（ログイン画面、認証状態管理）\n- i18n（ログイン画面の多言語対応）\n\n### 変更不要（既に対応済み）\n\n- `src/hooks/useWebSocket.ts` - wss://自動検出済み\n- `next.config.js` - CSPでws:/wss:両方許可済み\n\n### 関連Issue\n\n- Issue #179: 旧トークン認証削除（教訓: クライアント側環境変数にトークンを含めない）","title":"トークン認証によるログイン機能の追加"}

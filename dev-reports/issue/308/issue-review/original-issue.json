{"body":"## 概要\n\nCommandMate UIからgit cloneを実行すると、`.env`ファイルに設定した`CM_ROOT_DIR`のディレクトリではなく、`/private/tmp/repos`配下にリポジトリが作成される。\n\n## 再現手順\n\n1. `.env`ファイルに`CM_ROOT_DIR`を設定する（例: `CM_ROOT_DIR=/Users/xxx/repos`）\n2. CommandMateサーバーを起動する\n3. ブラウザでCommandMate UIにアクセスする\n4. リポジトリURLを入力してcloneを実行する\n5. cloneされたリポジトリが`/private/tmp/repos`配下に作成される\n\n## 期待する動作\n\n`.env`ファイルに設定した`CM_ROOT_DIR`のディレクトリ配下にリポジトリがcloneされること。\n\n## 実際の動作\n\n`CM_ROOT_DIR`の設定に関わらず、`/private/tmp/repos`（macOSでは`/tmp` -> `/private/tmp`のシンボリックリンク）配下にリポジトリが作成される。\n\n## 根本原因の仮説\n\n`CloneManager`のコンストラクタ（`src/lib/clone-manager.ts` L193）で`basePath`のデフォルト値が`'/tmp/repos'`にハードコードされている。\n\n```typescript\n// src/lib/clone-manager.ts L193\nbasePath: config.basePath || process.env.WORKTREE_BASE_PATH || '/tmp/repos',\n```\n\nclone APIルート（`src/app/api/repositories/clone/route.ts` L71）では`CloneManager`を`new CloneManager(db)`として初期化しており、`basePath`（`config`）を渡していない。そのため`CM_ROOT_DIR`が参照されず、常にフォールバック値`/tmp/repos`が使用される。\n\nまた、`src/lib/env.ts`で`CM_ROOT_DIR`は`getEnv()`経由で取得可能だが、`CloneManager`はこれを利用していない。`WORKTREE_BASE_PATH`という別の環境変数を直接参照しており、環境変数の命名体系と不整合が生じている。\n\n## 対策案\n\n### 方針: CM_ROOT_DIR への統一\n\n1. **clone APIルートの修正**（`src/app/api/repositories/clone/route.ts`、`src/app/api/repositories/clone/[jobId]/route.ts`）\n   - `CloneManager`初期化時に`getEnv().CM_ROOT_DIR`を`basePath`として渡す\n2. **CloneManagerのデフォルト値改善**（`src/lib/clone-manager.ts`）\n   - `basePath`のフォールバックを`getEnv().CM_ROOT_DIR`に変更し、`WORKTREE_BASE_PATH`は非推奨化\n3. **ドキュメント整備**\n   - `.env.example`に`CM_ROOT_DIR`のclone先としての役割を明記\n\n## 実装タスク\n\n- [ ] `src/app/api/repositories/clone/route.ts`: CloneManager初期化時にgetEnv().CM_ROOT_DIRをbasePathとして渡す\n- [ ] `src/app/api/repositories/clone/[jobId]/route.ts`: 同上\n- [ ] `src/lib/clone-manager.ts`: basePathデフォルト値をgetEnv().CM_ROOT_DIRに変更\n- [ ] WORKTREE_BASE_PATHの非推奨化対応（deprecation warning追加）\n- [ ] ユニットテスト・統合テストの更新\n\n## 受入条件\n\n- [ ] `.env`に`CM_ROOT_DIR`を設定した状態で、UIからcloneすると`CM_ROOT_DIR`配下にリポジトリが作成される\n- [ ] `CM_ROOT_DIR`未設定時はprocess.cwd()をフォールバック値として使用する\n- [ ] `WORKTREE_BASE_PATH`設定時は非推奨警告を出力しつつ動作する（後方互換性）\n- [ ] 既存テストがすべてパスする\n- [ ] 新規テストでCM_ROOT_DIR反映を検証する\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/app/api/repositories/clone/route.ts` | CloneManager初期化時にbasePath指定追加 |\n| `src/app/api/repositories/clone/[jobId]/route.ts` | CloneManager初期化時にbasePath指定追加 |\n| `src/lib/clone-manager.ts` | basePathデフォルト値をCM_ROOT_DIRに変更、WORKTREE_BASE_PATH非推奨化 |\n| `tests/unit/lib/clone-manager.test.ts` | テスト更新 |\n| `tests/integration/api-clone.test.ts` | テスト更新 |\n\n### 関連コンポーネント\n\n- `src/lib/env.ts` - CM_ROOT_DIR取得（既存、変更不要）\n- `.env.example` - ドキュメント整備","title":"git clone時のディレクトリがおかしい"}

{"body":"## 概要\n\ntmuxセッションが定期的に削除（kill→再作成）される、またはUIでセッションが認識されない問題。主に3つの原因が特定されている。\n\n1. **サーバー側Auto-Yes Pollerの重複応答**: 同一プロンプトに対して繰り返し応答が送信され、Claude CLIが不正状態に陥り終了する\n2. **長時間実行タスクでのコンテキスト枯渇**: コンテキストウィンドウが枯渇するとClaude CLIが終了し、ヘルスチェックがセッションをkillする\n3. **ヘルスチェックの偽陽性（SHELL_PROMPT_ENDINGS誤判定）**: Claude CLIステータスバーの `Context left until auto-compact: N%` の末尾 `%` がzshシェルプロンプトと誤判定され、正常稼働中のセッションが「不健全」と判定される\n\nいずれの場合も、ヘルスチェック（`isSessionHealthy`）の判定によりセッションがkillされる、またはUIで `isSessionRunning: false` と表示される。\n\n## 再現手順\n\n### パターンA: Auto-Yes重複応答\n\n1. Worktreeに対してClaude CLIセッションを起動する\n2. Auto-Yesモードを有効にする\n3. Claude CLIが権限プロンプト等を表示する状態にする\n4. しばらく待つ（数分〜数十分）\n5. → セッションが消失し、再作成される\n\n### パターンB: コンテキスト枯渇\n\n1. Worktreeに対してClaude CLIセッションを起動する\n2. `/pm-auto-issue2dev` 等の長時間・大規模タスクを実行する（Auto-Yes有効）\n3. コンテキスト残量が1%程度まで低下する\n4. auto-compactが実行されるが、失敗またはCLI終了に至る\n5. → セッションが消失し、再作成される\n\n**実際の確認例（feature-299-worktree）**:\n- 経過時間: 1時間26分、トークン消費: 137.5k、変更: 50ファイル +303/-9行\n- Phase 5（TDD自動開発）途中でプロンプト待機状態に停止\n- コンテキスト残量: **1%**（ほぼ枯渇）\n\n### パターンC: ヘルスチェック偽陽性（SHELL_PROMPT_ENDINGS誤判定）\n\n1. Claude CLIセッションが正常に稼働している状態にする\n2. コンテキスト残量が低下し、ステータスバーに `Context left until auto-compact: N%` が表示される\n3. CommandMateのUIでWorktree詳細画面を開く\n4. → **tmuxセッションは存在しClaude CLIも正常稼働中なのに、UIではセッションが「停止中」と表示される**\n\n**実際の確認例（commandmate-marketing-main）**:\n- tmuxセッション `mcbd-claude-commandmate-marketing-main` は存在\n- Claude CLIはプロンプト待機中（`❯`）で正常稼働\n- ステータスバー末尾: `Context left until auto-compact: 7%`\n- API応答: `isSessionRunning: false`（誤判定）\n\n**原因**: `isSessionHealthy()` の `SHELL_PROMPT_ENDINGS` チェック（`claude-session.ts:58,288`）が、Claude CLIステータスバーの `7%` の末尾 `%` をzshシェルプロンプト `%` と誤判定している。\n\n```\ntmux出力の末尾行:\n  5 files +242 -113                        Context left until auto-compact: 7%\n                                                                             ^\n                                                                    この % がマッチ\n```\n\n## 期待する動作\n\n- Auto-Yesは各プロンプトに対して1回だけ応答を送信する\n- コンテキスト枯渇時にセッションが適切にハンドリングされる（即kill ではなく状態を保持）\n- Claude CLIのステータスバー表示（`N%`）がシェルプロンプトと誤判定されない\n- Claude CLIセッションが安定して維持される\n- セッションが意図せず削除されない\n\n## 実際の動作\n\n- Auto-Yes Pollerが同一プロンプトに対して繰り返し応答を送信する（feature-299で129回のSent responseを確認）\n- 重複キーストロークによりClaude CLIが不正状態に陥り終了する\n- コンテキスト枯渇時にClaude CLIが終了し、tmuxペインにシェルプロンプトが残る\n- **正常稼働中のClaude CLIセッションがヘルスチェックで偽陽性判定される**（`N%` → `%` 誤検出）\n- ヘルスチェックがシェルプロンプトを検出し、セッションをkillする\n- ログ上では `feature-287-worktree` が5回、`feature-288-worktree` が3回、`feature-302-worktree` が2回再作成されている\n\n## 根本原因\n\n### 原因1: サーバー側Auto-Yes Pollerの重複応答防止欠如\n\n`src/lib/auto-yes-manager.ts` の `pollAutoYes()`（274-369行）にサーバー側の重複防止メカニズムがない。\n\n```\nクライアント側（useAutoYes.ts）：重複防止あり\n  - promptKey による同一プロンプト判定（77-78行）\n  - lastServerResponseTimestamp による3秒ウィンドウ（68-73行）\n\nサーバー側（auto-yes-manager.ts）：重複防止なし ← 問題\n  - detectPrompt → sendPromptAnswer → scheduleNextPoll のループ\n  - 前回送信したプロンプトとの比較ロジックなし\n```\n\n障害シーケンス：\n1. Auto-Yesがプロンプトを検出し応答を送信\n2. Claude CLIが応答を処理する前に（2秒以内）次のポーリングが発生\n3. 同じプロンプトに重複応答が送信される\n4. 余分なキーストローク（矢印キー、Enter）がClaude CLIに送られる\n5. 予期しない入力によりClaude CLIが終了する\n6. tmuxペインにシェルプロンプト（$, %, #）が表示される\n7. ヘルスチェック（`isSessionHealthy`）が異常を検出\n8. 次のsend API呼び出しで `ensureHealthySession` がセッションをkill\n\n### 原因2: コンテキスト枯渇によるClaude CLI終了\n\n長時間実行タスク（`/pm-auto-issue2dev` 等）でコンテキストウィンドウが枯渇すると、Claude CLIがauto-compactを試みるが、以下のケースでセッション終了に至る：\n\n- auto-compact自体が失敗する場合\n- auto-compact後もコンテキストが不足する場合\n- コンテキスト残量1%でCLIが応答不能になる場合\n\nClaude CLI終了後、tmuxペインにはシェルプロンプトが表示され、ヘルスチェック（`isSessionHealthy`、`claude-session.ts:262-296`）が以下の条件で不健全と判定する：\n\n| 条件 | 行 | リスク |\n|------|-----|--------|\n| 空出力 (`trimmed === ''`) | 285 | 高 - 初期化中・CLI終了後に発生 |\n| シェルプロンプト末尾 (`$`, `%`, `#`) | 288 | 高 - CLIプロセス終了後に検出 |\n| エラーパターン一致 | 268-277 | 中 - 偽陽性の可能性 |\n\n現状のヘルスチェックは「CLIが終了した」ことは検出できるが、**終了理由を区別しない**。コンテキスト枯渇による正常終了もエラーとして扱われ、即座にセッションがkillされる。\n\n### 原因3: SHELL_PROMPT_ENDINGSの偽陽性（ヘルスチェック誤判定）\n\n`src/lib/claude-session.ts:58` で定義された `SHELL_PROMPT_ENDINGS` が、Claude CLIの正常な出力に含まれる `%` を誤検出する。\n\n```typescript\n// claude-session.ts:58\nconst SHELL_PROMPT_ENDINGS: readonly string[] = ['$', '%', '#'] as const;\n\n// claude-session.ts:288\nif (SHELL_PROMPT_ENDINGS.some(ending => trimmed.endsWith(ending))) {\n  return false;  // ← 偽陽性で不健全判定\n}\n```\n\n**誤判定のメカニズム**:\n- Claude CLIのステータスバーには `Context left until auto-compact: N%` が表示される\n- tmux capture-paneで取得した出力の末尾行がこのステータスバー行になる場合がある\n- `trimmed.endsWith('%')` が `7%` の `%` にマッチし、zshプロンプトと誤判定される\n- 結果として `isSessionHealthy()` が `false` を返し、正常稼働中のセッションが不健全扱いになる\n\n**影響**:\n- `isClaudeRunning()` が `false` を返すため、UIでセッションが「停止中」と表示される\n- `ensureHealthySession()` が呼ばれた場合、正常稼働中のセッションがkillされる\n- コンテキスト残量が低いセッション（長時間稼働中）ほど発生しやすい\n\n### 原因4: ヘルスチェックのkill時ログ不足\n\n`src/lib/claude-session.ts:306-313` の `ensureHealthySession()` がセッションをkillする際、なぜ不健全と判定されたかのログが出力されない。\n\n## 対策案\n\n### 対策1: SHELL_PROMPT_ENDINGSの判定ロジック改善（必須・最優先）\n\n単純な `endsWith` ではなく、シェルプロンプトの典型的なパターンをより正確に判定する。\n\n```typescript\n// 案A: 行末の % の前が数字でないことを確認（N% パターンを除外）\nconst lastLine = trimmed.split('\\n').pop()?.trim() ?? '';\nif (SHELL_PROMPT_ENDINGS.some(ending => {\n  if (!lastLine.endsWith(ending)) return false;\n  // N% パターン（コンテキスト残量表示）を除外\n  if (ending === '%' && /\\d+%$/.test(lastLine)) return false;\n  return true;\n})) {\n  return false;\n}\n\n// 案B: 最終行が短い（シェルプロンプトは通常短い）ことも条件に加える\n// 案C: Claude CLI固有のパターン（❯, spinner等）が出力に含まれる場合は健全と判定\n```\n\n### 対策2: サーバー側Auto-Yes Pollerに重複応答防止を追加（必須）\n\n`AutoYesPollerState` に `lastAnsweredPromptKey` フィールドを追加し、同一プロンプトへの再送信を防止する。\n\n```typescript\n// auto-yes-manager.ts の pollAutoYes() に追加\nconst promptKey = `${promptDetection.promptData.type}:${promptDetection.promptData.question}`;\nif (pollerState.lastAnsweredPromptKey === promptKey) {\n  scheduleNextPoll(worktreeId, cliToolId);\n  return;\n}\n// ... sendPromptAnswer() ...\npollerState.lastAnsweredPromptKey = promptKey;\n```\n\n### 対策3: コンテキスト枯渇の検出と通知（推奨）\n\nコンテキスト残量が低下した場合にUIへ通知し、ユーザーに判断を委ねる。\n\n- tmux出力から `Context left until auto-compact: N%` パターンを検出\n- 閾値（例: 10%）以下になった場合にUI通知（バナー等）\n- Auto-Yesの自動停止オプション（コンテキスト残量低下時にAuto-Yesを無効化）\n\n### 対策4: ヘルスチェックのkill時にログ出力を追加（推奨）\n\n`ensureHealthySession()` で不健全判定の理由をログに出力する。\n\n```typescript\nasync function ensureHealthySession(sessionName: string): Promise<boolean> {\n  const healthy = await isSessionHealthy(sessionName);\n  if (!healthy) {\n    console.warn(`[health-check] Session ${sessionName} is unhealthy, killing...`);\n    await killSession(sessionName);\n    return false;\n  }\n  return true;\n}\n```\n\n### 対策5: 応答送信後のクールダウン期間追加（推奨）\n\n応答送信後、一定時間（例: 5秒）はポーリングをスキップし、Claude CLIが応答を処理する時間を確保する。\n\n## 実装タスク\n\n- [ ] `SHELL_PROMPT_ENDINGS` の判定ロジック改善（`N%` パターン除外）\n- [ ] `isSessionHealthy()` にClaude CLI固有パターンの肯定的検出を追加\n- [ ] `AutoYesPollerState` に `lastAnsweredPromptKey: string | null` を追加\n- [ ] `pollAutoYes()` で前回応答済みプロンプトとの比較ロジックを実装\n- [ ] 応答送信後のクールダウン期間を追加（応答後は通常の2秒ではなく5秒待機）\n- [ ] コンテキスト残量検出パターンの追加（`cli-patterns.ts`）\n- [ ] コンテキスト残量低下時のUI通知メカニズム検討\n- [ ] `ensureHealthySession()` に不健全理由のログ出力を追加\n- [ ] `isSessionHealthy()` に不健全判定理由の構造化ログを追加\n- [ ] ユニットテスト追加（SHELL_PROMPT_ENDINGS偽陽性防止、重複防止、クールダウン動作）\n\n## 受入条件\n\n- [ ] Claude CLIのステータスバー `Context left until auto-compact: N%` がシェルプロンプトと誤判定されないこと\n- [ ] サーバー側Auto-Yes Pollerが同一プロンプトに対して1回のみ応答を送信すること\n- [ ] 応答送信後にクールダウン期間が適用されること\n- [ ] ヘルスチェックによるセッションkill時にログが出力されること\n- [ ] 既存のAuto-Yesテストが全てパスすること\n- [ ] 長時間（30分以上）のAuto-Yesセッションでセッションが安定維持されること\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/lib/claude-session.ts` | SHELL_PROMPT_ENDINGS判定ロジック改善、ヘルスチェックのログ出力強化 |\n| `src/lib/auto-yes-manager.ts` | 重複応答防止ロジック追加、クールダウン期間追加 |\n| `src/lib/cli-patterns.ts` | コンテキスト残量検出パターン追加 |\n| `tests/unit/claude-session.test.ts` | SHELL_PROMPT_ENDINGS偽陽性防止テスト、ヘルスチェックログのテスト追加 |\n| `tests/unit/auto-yes-manager.test.ts` | 重複防止・クールダウンのテスト追加 |\n\n### 関連コンポーネント\n\n- `src/hooks/useAutoYes.ts`（クライアント側 - 変更不要、既に重複防止あり）\n- `src/lib/auto-yes-resolver.ts`（変更不要）\n- `src/app/api/worktrees/[id]/send/route.ts`（変更不要、startSession呼び出し元）\n- `src/lib/response-poller.ts`（コンテキスト残量検出の連携先候補）","title":"fix: Auto-Yes Pollerの重複応答によりtmuxセッションが定期的に削除される"}

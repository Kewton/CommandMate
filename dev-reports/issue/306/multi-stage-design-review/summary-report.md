# マルチステージ設計レビュー完了報告

## Issue #306

### ステージ別結果

| Stage | レビュー種別 | 指摘数 | 対応数 | ステータス |
|-------|------------|-------|-------|----------|
| 1 | 通常レビュー（設計原則） | 10 (MF:1, SF:4, NTH:5) | 10 | ✅ |
| 2 | 整合性レビュー | 10 (MF:2, SF:4, NTH:4) | 10 | ✅ |
| 3 | 影響分析レビュー | 10 (MF:1, SF:5, NTH:4) | 10 | ✅ |
| 4 | セキュリティレビュー | 8 (MF:0, SF:3, NTH:5) | 8 | ✅ |

### 統計

- **総指摘数**: 38件
- **Must Fix**: 4件（全対応済み）
- **Should Fix**: 16件（全対応済み）
- **Nice to Have**: 18件（対応済み/現状維持確認）

### Must Fix指摘の要約

| ID | Stage | 内容 | 対応 |
|----|-------|------|------|
| F006 | 1 | 多段防御の適用順序不備（行長チェックをSHELL_PROMPT_ENDINGSの前に移動） | 設計書修正済み |
| S2-F001 | 2 | isClaudeRunning()コード例のawait欠落 | 設計書修正済み |
| S2-F010 | 2 | empty output/error patternのHealthCheckResult形式コード例欠如 | 設計書修正済み |
| S3-F001 | 3 | isSessionHealthy()のcatchブロックのHealthCheckResult形式変更漏れ | 設計書修正済み |

### 設計方針書の主な更新内容

1. **多段防御の適用順序修正**: 行長チェック → SHELL_PROMPT_ENDINGS判定の順に変更
2. **HealthCheckResult**: interfaceも@internal export、catch含む全returnパスを網羅
3. **promptKey共通化**: `src/lib/prompt-key.ts` 新規作成
4. **isDuplicatePrompt()ヘルパー**: pollAutoYes()の責務分散
5. **テスト影響テーブル拡充**: 4ファイルの影響分析追加
6. **セキュリティ対策**: generatePromptKey用途制限、ログ安全性、scheduleNextPoll下限値ガード

### 変更ファイル一覧

- `dev-reports/design/issue-306-session-stability-design-policy.md`（設計方針書）

### 次のアクション

- [ ] 作業計画立案
- [ ] TDD実装開始

---

*Generated by multi-stage-design-review command*

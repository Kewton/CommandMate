{"body":"## 概要\n\nClaudeがインタラクティブプロンプト（チェックボックス・番号付き選択肢）を含む応答を返した際、選択肢の前に表示される指示テキスト/コンテキスト文が空白になり表示されない。\n\n## 再現手順\n\n1. Claudeセッションで `/issue-enhance` などの対話的コマンドを実行\n2. Claudeがチェックボックス付きの質問（例：スコープ選択）を返す\n3. ターミナル上部の指示テキストが空白の横線として表示される\n\n## 期待される動作\n\nClaudeの応答全文（指示テキスト + 質問 + 選択肢）が表示される。\n\n## 実際の動作\n\n- 指示テキスト（上部）: **非表示**（空白の横線）\n- チェックボックス/選択肢: 表示される\n- 質問文: 表示される（選択肢直前5行以内のため）\n\n## スクリーンショット\n![Screenshot_20260210-215817.png](https://github.com/user-attachments/assets/5488529e-714e-4b55-8d62-95030b9ad8c0)\n\n## 根本原因分析\n\n### 原因\n\n`src/lib/prompt-detector.ts` の `cleanContent` 生成ロジックが質問テキストのみ（最大5行）を抽出し、Claudeの指示メッセージを切り捨てている。\n\n### データフロー\n\n```\n[tmux output（完全なClaude応答）]\n  ↓\n[response-poller.ts] extractResponse() → 完全テキスト取得\n  ↓\n[prompt-detector.ts] detectPrompt() → cleanContent = 質問のみ（5行制限）\n  ↓\n[response-poller.ts:618] createMessage(content: cleanContent) → 指示メッセージ喪失\n  ↓\n[PromptMessage.tsx] promptData.question のみ表示 → 空白\n```\n\n### 問題箇所\n\n1. **`src/lib/prompt-detector.ts`（471-486行目）**: `extractQuestionText()` が `questionEndIndex - 5` で5行制限\n2. **`src/lib/prompt-detector.ts`（488-509行目）**: `cleanContent: question.trim()` で質問テキストのみ返却\n3. **`src/lib/prompt-detector.ts`（116-132行目）**: Yes/Noパターンも同様に質問キャプチャのみ\n4. **`src/lib/response-poller.ts`（618行目）**: `content: promptDetection.cleanContent` で切り捨てられた内容のみDB保存\n5. **`src/components/worktree/PromptMessage.tsx`**: `message.content` が未使用で表示されない\n\n## 修正方針\n\n### 方針B: rawContentフィールド導入（採用）\n\n`PromptDetectionResult` に `rawContent` フィールドを新設し、完全なプロンプト出力を保持する。既存の `cleanContent` は変更せず後方互換性を維持。\n\n```typescript\n// prompt-detector.ts\nexport interface PromptDetectionResult {\n  isPrompt: boolean;\n  promptData?: PromptData;\n  cleanContent: string;    // 質問テキストのみ（既存のまま）\n  rawContent?: string;     // NEW: 完全なプロンプト出力（stripAnsi済み）\n}\n```\n\n**選定理由**:\n- 後方互換性が高い（cleanContentは既存ロジックを壊さない）\n- rawContent未設定時のフォールバック機構が自然\n- 将来的な拡張が容易\n\n### 不採用案\n- **方針A（cleanContent全文化）**: 既存ロジックへの影響が懸念\n- **方針C（promptData埋め込み）**: promptDataの肥大化、Auto-Yesへの不要データ混入\n\n## 実装タスク\n\n- [ ] `src/lib/prompt-detector.ts`: `PromptDetectionResult` 型に `rawContent?: string` を追加\n- [ ] `src/lib/prompt-detector.ts`: `detectMultipleChoicePrompt()` で `rawContent: output.trim()` を返却\n- [ ] `src/lib/prompt-detector.ts`: Yes/Noパターン検出で `rawContent: lastLines.trim()` を返却\n- [ ] `src/lib/response-poller.ts:618`: `content: promptDetection.rawContent || promptDetection.cleanContent` に変更\n- [ ] `src/components/worktree/PromptMessage.tsx`: `message.content`（指示テキスト）の表示を追加\n- [ ] 既存テストの確認・必要に応じて更新\n\n## 受入条件\n\n- [ ] プロンプト検出時にClaudeの指示メッセージがDBに保存されること\n- [ ] PromptMessage UIで指示テキストが表示されること\n- [ ] 既存のプロンプト検出・応答機能（Auto-Yes含む）に影響がないこと\n- [ ] 既存テストがすべてパスすること\n\n## 影響範囲\n\n### 変更対象ファイル\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/lib/prompt-detector.ts` | `PromptDetectionResult` 型拡張、rawContent返却追加 |\n| `src/lib/response-poller.ts` | DB保存時のcontent値をrawContent優先に変更 |\n| `src/components/worktree/PromptMessage.tsx` | message.content（指示テキスト）の表示追加 |\n\n### 影響なしの確認済みコンポーネント\n\n| コンポーネント | 理由 |\n|-------------|------|\n| `auto-yes-manager.ts` | `promptData`のみ使用、cleanContent/rawContentに依存しない |\n| `auto-yes-resolver.ts` | `promptData`のみ使用 |\n| `status-detector.ts` | `isPrompt`フラグのみ参照 |\n| `claude-session.ts` | セッション管理のみ、プロンプト検出に非関与 |\n| DBスキーマ | `content TEXT`は制限なし、スキーマ変更不要 |\n\n### 関連コンポーネント\n\n- `src/lib/cli-tools/codex.ts` - Codexセッションでも同様のプロンプト検出を使用\n- `src/components/worktree/MessageList.tsx` - メッセージリスト表示（間接的影響）","title":"fix: プロンプト検出時にClaudeの指示メッセージが切り捨てられ表示されない"}

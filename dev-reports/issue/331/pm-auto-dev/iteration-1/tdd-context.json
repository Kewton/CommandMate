{
  "issue_number": 331,
  "title": "トークン認証によるログイン機能の追加",
  "acceptance_criteria": [
    "commandmate start で認証なし・HTTPで起動でき、従来と同じ動作をすること（後方互換性）",
    "src/middleware.ts が存在していても、CM_AUTH_TOKEN_HASH 未設定時は NextResponse.next() を返し、既存動作に一切影響しないこと",
    "commandmate start --auth で認証有効のサーバーが起動し、トークンがターミナルに表示されること",
    "--auth-expire 48h で有効期限を指定でき、デフォルトは24時間であること",
    "--auth-expire に無効なフォーマットを指定した場合、エラーメッセージが表示され起動が中断されること",
    "未認証時にログイン画面が表示されること",
    "正しいトークンでログインでき、Cookieが設定されること（HttpOnly + SameSite=Strict + HTTPS時Secure）",
    "不正なトークンでログインが拒否されること",
    "認証済みの場合、全APIルートにアクセスできること",
    "認証済みの場合、WebSocket接続が成功すること",
    "未認証の場合、APIルートが401を返すこと",
    "未認証の場合、WebSocket接続が拒否されること",
    "サーバー停止でトークンが失効すること",
    "Cookieの有効期限がトークンの残り有効期限と一致すること",
    "旧CM_AUTH_TOKENが.envに残っている場合、起動時に警告メッセージが表示されること",
    "認証済みユーザーが /login にアクセスした場合、メインページにリダイレクトされること",
    "CookieにSameSite=Strict属性が設定されていること（CSRF対策）",
    "ログイン失敗を5回繰り返すと、そのIPからのログインが15分間ブロックされること（ブルートフォース対策）",
    "ブロック中にログインを試みると429ステータスが返却されること",
    "認証成功後に失敗カウントがリセットされること",
    "ログイン画面にロックアウト状態が表示されること",
    "--auth 指定時に --cert/--key がない場合、mkcertコマンド例を含む警告メッセージが表示されHTTPで起動すること",
    "--auth --allow-http 指定時に警告が抑制されること",
    "--auth --cert ./cert.pem --key ./key.pem でHTTPSサーバーとして起動すること",
    "--https --cert ./cert.pem --key ./key.pem で認証なしHTTPSサーバーとして起動すること",
    "HTTPS起動時にWebSocketがwss://で接続できること",
    "HTTPS起動時にCookieにSecure属性が付与されること",
    "証明書ファイルが存在しない場合、エラーメッセージが表示されること",
    "HTTPS起動時に server.ts と start.ts のコンソール出力が https:// でURLを表示すること",
    "commandmate start --auth --daemon でデーモンモード起動時に認証オプションが子プロセスに正しく伝達されること",
    "デーモンモードでHTTPS起動時に commandmate status がHTTPS URLで状態確認できること",
    "auth.tsのトークン生成・検証のユニットテストが全てパスすること",
    "レート制限のユニットテストが全てパスすること",
    "認証ミドルウェアの統合テストが全てパスすること",
    "WebSocket認証の統合テストが全てパスすること",
    "CLIオプションパースのテストが全てパスすること"
  ],
  "implementation_tasks": [
    "1. src/lib/auth.ts 新規作成 - トークン生成(crypto.randomBytes)・検証(timingSafeEqual)・有効期限管理・Cookieパース・レート制限",
    "2. src/middleware.ts 新規作成 - HTTPリクエスト認証（CM_AUTH_TOKEN_HASH未設定時はNextResponse.next()を即返す）",
    "3. src/app/api/auth/login/route.ts 新規作成 - ログインAPI（レート制限・HttpOnly Cookie設定・maxAge計算）",
    "4. src/app/api/auth/logout/route.ts 新規作成 - ログアウトAPI（Cookie削除・リダイレクト）",
    "5. src/app/api/auth/status/route.ts 新規作成 - 認証状態確認API",
    "6. src/app/login/page.tsx 新規作成 - ログイン画面（レート制限表示・認証済みリダイレクト・i18n対応）",
    "7. src/lib/ws-server.ts 修正 - WebSocket認証チェック追加・setupWebSocket()引数型を http.Server | https.Server に拡張",
    "8. server.ts 修正 - HTTP/HTTPS条件分岐・証明書読み込み・バリデーション・gracefulShutdownにレート制限クリーンアップ追加",
    "9. src/cli/commands/start.ts 修正 - --auth/--auth-expire/--https/--cert/--key/--allow-http オプション追加・トークン生成フロー・旧CM_AUTH_TOKEN警告",
    "10. src/cli/index.ts 修正 - startコマンドのcommander option定義追加",
    "11. src/cli/types/index.ts 修正 - StartOptions型に認証・HTTPSオプション追加",
    "12. src/lib/env.ts 修正 - 認証・HTTPS関連オプショナルフィールド追加",
    "13. src/cli/utils/env-setup.ts 修正 - CM_HTTPS_CERT/CM_HTTPS_KEY 環境変数対応",
    "14. src/cli/utils/daemon.ts 修正 - DaemonManager.start()への認証・HTTPSオプション伝達・getStatus()のHTTPS URL対応",
    "15. src/cli/config/security-messages.ts 修正 - --auth有効時のメッセージ条件分岐",
    "16. locales/en/auth.json 新規作成 - 認証関連英語翻訳",
    "17. locales/ja/auth.json 新規作成 - 認証関連日本語翻訳",
    "18. src/i18n.ts 修正 - auth名前空間のimport・merge追加",
    "19. tsconfig.server.json 修正 - include配列にsrc/lib/auth.tsを追加",
    "20. src/components/sidebar/ 修正 - ログアウトボタン追加（認証有効時のみ表示）",
    "21. src/components/mobile/ 修正 - モバイル版ログアウトボタン追加",
    "22. tests/unit/auth.test.ts 新規作成",
    "23. tests/unit/rate-limiter.test.ts 新規作成",
    "24. tests/integration/auth-middleware.test.ts 新規作成",
    "25. tests/integration/ws-auth.test.ts 新規作成",
    "26. tests/unit/cli-auth-options.test.ts 新規作成",
    "27. tests/integration/i18n-namespace-loading.test.ts 修正 - auth名前空間を期待値に追加",
    "28. docs/security-guide.md 修正 - トークン認証+HTTPS使用方法・証明書手順追記",
    "29. CLAUDE.md 修正 - 新規モジュールのモジュール一覧追記",
    ".env.example 修正 - 認証・HTTPS関連コメント付きサンプル追記"
  ],
  "design_doc_path": "dev-reports/design/issue-331-token-auth-design-policy.md",
  "work_plan_path": "dev-reports/issue/331/work-plan.md",
  "target_coverage": 80,
  "key_constraints": [
    "src/lib/auth.ts は Next.js 固有モジュール（next/headers, next/server等）への依存を禁止（CLIビルド互換性制約）",
    "AUTH_EXCLUDED_PATHS のパスマッチングは === を使用（startsWith禁止 - S002セキュリティ修正）",
    "トークン検証には crypto.timingSafeEqual() を使用（タイミング攻撃対策 - S001）",
    "WebSocket認証は ws-server.ts で独立実装（middleware.ts に依存しない）",
    "CM_AUTH_TOKEN_HASH 未設定時は middleware.ts が即座に NextResponse.next() を返す（後方互換性）",
    "Cookie値はトークン平文を格納（HttpOnly+SameSite=Strict+HTTPS時Secure）",
    "auth-expire フォーマット: Nh/Nd/Nm、最小1h、最大30d",
    "レート制限: 5回失敗→15分ロックアウト、1時間ごとのクリーンアップタイマー",
    "server.ts ExitCodeはsrc/cli/types/index.tsから参照不可→数値2を直接使用"
  ]
}

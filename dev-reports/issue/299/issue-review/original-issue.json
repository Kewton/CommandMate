{"body":"## 概要\n\niPad（Chrome）およびスマートフォンでのレイアウト崩れ・全画面表示の不具合。3つの症状が確認されている。\n\n1. **iPad: トップ画面のレイアウト崩れ**（横置きのみ）\n2. **iPad: Markdownファイル表示崩れ**（横置きのみ）\n3. **iPad: 全画面表示時に真っ白**（縦置き・横置き双方）\n4. **スマホ: Markdown全画面表示時に上スクロールで全画面が解除される**\n\n## 環境\n\n- **ブラウザ**: Chrome\n- **iPad**: 横置き・縦置き双方で確認（全画面空白は双方、それ以外は横置きのみ）\n- **スマホ**: 全画面スクロール解除（スクリーンショットなし）\n\n## 再現手順\n\n### 症状1: iPad トップ画面崩れ（横置き）\n1. iPadでChromeを開く\n2. CommandMateのトップ画面（Worktree一覧）にアクセス\n3. iPadを横置きにする\n4. → レイアウトが崩れる\n\n### 症状2: iPad Markdownファイル表示崩れ（横置き）\n1. iPadでChromeを開く（横置き）\n2. Worktree詳細画面でMarkdownファイルを選択\n3. → 表示が崩れる\n\n### 症状3: iPad 全画面表示時に真っ白（縦置き・横置き双方）\n1. iPadでChromeを開く\n2. Markdownエディタの全画面（最大化）ボタンを押す\n3. → 画面が真っ白になる\n\n### 症状4: スマホ 全画面スクロール解除\n1. スマホでMarkdownファイルを全画面表示する\n2. 上方向にスクロールする\n3. → 全画面が意図せず解除される\n\n## 期待する動作\n\n- iPad横置き・縦置きともにレイアウトが正しく表示される\n- Markdownファイルがどのデバイスでも正しく表示される\n- 全画面表示が正常に動作し、白画面にならない\n- スマホでの全画面表示中、コンテンツのスクロールで全画面が解除されない\n\n## 実際の動作\n\n- iPad横置き時にトップ画面・Markdownファイル表示のレイアウトが崩れる\n- iPad全画面表示時に画面が真っ白になる（縦置き・横置き双方）\n- スマホで全画面中に上スクロールすると全画面が解除される\n\n## 根本原因の仮説\n\n### 症状1・2: iPad横置きレイアウト崩れ\n\n- **`useIsMobile.ts`のbreakpoint問題**: iPad横置き（1024px以上）はデスクトップ扱いになるが、画面サイズに対してデスクトップレイアウトが最適化されていない\n- **Hydration mismatch**: `useIsMobile`の初期値が`false`のため、SSR時とクライアント初期化時でレイアウトが異なる可能性\n- **z-index stacking context混在**: Desktop sidebar（z-30）とMobile drawer（z-50）が混在する可能性\n\n### 症状3: 全画面表示時の白画面\n\n- **CSS Fallbackの`fixed inset-0`問題**: iPadOS ChromeでFullscreen APIがサポートされない場合、CSSフォールバック（`fixed inset-0`）が使用されるが、stacking contextやz-indexの問題で内容が非表示になる可能性\n- **Portal位置指定の問題**: `MarkdownEditor.tsx`のfallbackモードでPortalが`document.body`に追加されるが、z-indexやoverflowの制御が不適切な可能性\n- **`useFullscreen.ts`のiOS検出ロジック**: iPadOS ChromeがiOSデバイスとして正しく検出されるかの問題\n\n### 症状4: スマホ全画面スクロール解除\n\n- **`useSwipeGesture`のthreshold問題**: `MarkdownEditor.tsx`でswipeDown検出時に`exitFullscreen()`を呼んでいるが、threshold（100px）が小さく、通常のスクロール操作でも全画面解除が発動する可能性\n- **スクロール方向の誤判定**: コンテンツ内の上方向スクロールがswipeDown gestureとして検出される\n\n## 対策案\n\n### 症状1・2: レイアウト崩れ対策\n\n- iPad横置き（768px〜1024px付近）のレイアウト最適化\n- タブレット向けのレスポンシブ調整（breakpointまたはコンテナクエリ）\n\n### 症状3: 全画面白画面対策\n\n- iPadOS Chrome向けのFullscreen APIサポート確認と分岐\n- CSSフォールバック時のz-index・overflow制御の見直し\n- Portal使用時のstacking context確認\n\n### 症状4: スクロール解除対策\n\n- `useSwipeGesture`のthreshold引き上げ（100px → 150px以上）\n- スクロール操作とスワイプジェスチャーの判定ロジック改善（コンテンツ内スクロール中はスワイプ判定を無効化）\n\n## 影響範囲\n\n### 変更対象ファイル（候補）\n\n| ファイル | 変更内容 |\n|---------|---------|\n| `src/hooks/useIsMobile.ts` | タブレット判定ロジックの見直し |\n| `src/hooks/useFullscreen.ts` | iPadOS Chrome向けフォールバック修正 |\n| `src/components/worktree/MarkdownEditor.tsx` | 全画面表示・スワイプ判定の修正 |\n| `src/components/layout/AppShell.tsx` | iPad横置き時のレイアウト調整 |\n| `src/components/worktree/WorktreeDesktopLayout.tsx` | タブレット向けレイアウト調整 |\n| `src/hooks/useSwipeGesture.ts` | スワイプ判定threshold・ロジック修正 |\n\n### 関連コンポーネント\n\n- `src/components/layout/MainLayout.tsx`\n- `src/components/mobile/MobileHeader.tsx`\n- `src/components/mobile/MobileTabBar.tsx`\n- `src/components/worktree/FileViewer.tsx`\n- `src/components/ui/Modal.tsx`\n\n## スクリーンショット\n\n### iPad\n![E9FDBA27-B929-46FF-92BA-ADA12EEC3371.PNG](https://github.com/user-attachments/assets/38246cb4-b9b9-4453-b097-a15462abd476)\n\n![353F2E1D-83D6-430A-A9D7-3EC91FDF8607.PNG](https://github.com/user-attachments/assets/c0037ec8-f94d-46ae-829a-c900ac773587)\n\n![838F7F39-FE84-4A30-92EA-6C8AD99FD98A.PNG](https://github.com/user-attachments/assets/5f1f1f28-7c90-4175-a04f-c05b51ff201e)\n\n### スマホ\n（スクリーンショットなし）","title":"レイアウトが崩れる"}

{
  "issue_number": 331,
  "feature_summary": "トークン認証によるログイン機能の追加（HTTPS対応含む）",
  "acceptance_criteria": [
    "commandmate start で認証なし・HTTPで起動でき、従来と同じ動作をすること（後方互換性）",
    "src/middleware.ts が存在していても、CM_AUTH_TOKEN_HASH 未設定時は NextResponse.next() を返し、既存動作に一切影響しないこと",
    "commandmate start --auth で認証有効のサーバーが起動し、トークンがターミナルに表示されること",
    "--auth-expire 48h で有効期限を指定でき、デフォルトは24時間であること",
    "--auth-expire に無効なフォーマットを指定した場合、エラーメッセージが表示され起動が中断されること",
    "未認証時にログイン画面が表示されること",
    "正しいトークンでログインでき、Cookieが設定されること（HttpOnly + SameSite=Strict + HTTPS時Secure）",
    "不正なトークンでログインが拒否されること",
    "認証済みの場合、全APIルートにアクセスできること",
    "認証済みの場合、WebSocket接続が成功すること",
    "未認証の場合、APIルートが401を返すこと",
    "未認証の場合、WebSocket接続が拒否されること",
    "サーバー停止でトークンが失効すること",
    "Cookieの有効期限がトークンの残り有効期限と一致すること",
    "旧CM_AUTH_TOKENが.envに残っている場合、起動時に警告メッセージが表示されること",
    "認証済みユーザーが /login にアクセスした場合、メインページにリダイレクトされること",
    "CookieにSameSite=Strict属性が設定されていること（CSRF対策）",
    "ログイン失敗を5回繰り返すと、そのIPからのログインが15分間ブロックされること（ブルートフォース対策）",
    "ブロック中にログインを試みると429ステータスが返却されること",
    "認証成功後に失敗カウントがリセットされること",
    "ログイン画面にロックアウト状態が表示されること",
    "--auth 指定時に --cert/--key がない場合、mkcertコマンド例を含む警告メッセージが表示されHTTPで起動すること",
    "--auth --allow-http 指定時に警告が抑制されること",
    "--auth --cert ./cert.pem --key ./key.pem でHTTPSサーバーとして起動すること",
    "--https --cert ./cert.pem --key ./key.pem で認証なしHTTPSサーバーとして起動すること",
    "HTTPS起動時にWebSocketがwss://で接続できること",
    "HTTPS起動時にCookieにSecure属性が付与されること",
    "証明書ファイルが存在しない場合、エラーメッセージが表示されること",
    "HTTPS起動時に server.ts と start.ts のコンソール出力が https:// でURLを表示すること",
    "commandmate start --auth --daemon でデーモンモード起動時に認証オプションが子プロセスに正しく伝達されること",
    "デーモンモードでHTTPS起動時に commandmate status がHTTPS URLで状態確認できること",
    "auth.tsのトークン生成・検証のユニットテストが全てパスすること",
    "レート制限のユニットテストが全てパスすること",
    "認証ミドルウェアの統合テストが全てパスすること",
    "WebSocket認証の統合テストが全てパスすること",
    "CLIオプションパースのテストが全てパスすること",
    "セキュリティガイドにmkcertによる証明書生成手順が記載されていること（macOS / Linux両方）",
    "セキュリティガイドにトークン認証+HTTPSのクイックスタート手順が記載されていること"
  ],
  "test_scenarios": [
    "シナリオ1: 後方互換性 - CM_AUTH_TOKEN_HASHなしでmiddleware.tsが存在してもNextResponse.next()を返す",
    "シナリオ2: トークン生成 - generateToken()が64文字のhex文字列を生成すること",
    "シナリオ3: トークン検証 - verifyToken()がtimingSafeEqualを使い有効期限チェックも行うこと",
    "シナリオ4: セキュリティ(S001) - tracing safe equalで実装されているか",
    "シナリオ5: セキュリティ(S002) - 認証除外パスの完全一致マッチング（/login-hack等はブロック）",
    "シナリオ6: レート制限 - 5回失敗で15分ロックアウト・429返却",
    "シナリオ7: レート制限リセット - 認証成功でカウントリセット",
    "シナリオ8: WebSocket認証 - Cookie付きWS接続成功・Cookie無しWS接続拒否",
    "シナリオ9: i18n - auth名前空間が正しく読み込まれること",
    "シナリオ10: CLIオプション - StartOptionsにauth/authExpire/cert/key/allowHttpが含まれる",
    "シナリオ11: parseDuration - Nh/Nd/Nmフォーマット、最小1h最大30d、無効値エラー",
    "シナリオ12: HTTPS条件分岐 - CM_HTTPS_CERT/CM_HTTPS_KEYありでhttpsサーバー作成",
    "シナリオ13: ログアウトAPI - Cookie削除が行われること",
    "シナリオ14: 認証状態API - authEnabled: boolean を返すこと",
    "シナリオ15: ビルド確認 - tsc/lint/build/build:server/build:cli全てパス"
  ],
  "implemented_files": [
    "src/lib/auth.ts",
    "src/middleware.ts",
    "src/app/api/auth/login/route.ts",
    "src/app/api/auth/logout/route.ts",
    "src/app/api/auth/status/route.ts",
    "src/app/login/page.tsx",
    "src/components/common/LogoutButton.tsx",
    "src/lib/ws-server.ts",
    "server.ts",
    "src/cli/commands/start.ts",
    "src/cli/index.ts",
    "src/cli/types/index.ts",
    "src/cli/utils/daemon.ts",
    "src/cli/config/security-messages.ts",
    "src/lib/env.ts",
    "src/i18n.ts",
    "locales/en/auth.json",
    "locales/ja/auth.json",
    "tsconfig.server.json",
    ".env.example"
  ],
  "tdd_result_path": "dev-reports/issue/331/pm-auto-dev/iteration-1/tdd-result.json"
}

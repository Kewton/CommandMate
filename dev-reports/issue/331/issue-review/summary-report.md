# Issue #331 マルチステージレビュー完了報告

## レビュー日時
- 開始: 2026-02-21
- 完了: 2026-02-21

## 仮説検証結果（Phase 0.5）

| # | 仮説/主張 | 判定 |
|---|----------|------|
| 1 | useWebSocket.tsはwss://自動検出対応済み | Confirmed |
| 2 | next.config.jsのCSPでws:/wss:両方許可済み | Confirmed |
| 3 | server.tsはHTTPのみ（HTTPS条件分岐が未実装） | Confirmed |
| 4 | ws-server.tsのupgradeハンドラーに認証チェックがない | Confirmed |
| 5 | StartOptionsにHTTPS/auth関連オプションが未実装 | Confirmed |
| 6 | src/middleware.tsが未存在（新規作成が必要） | Confirmed |
| 7 | src/lib/env.tsにHTTPS関連環境変数が未実装 | Confirmed |
| 8 | src/cli/utils/env-setup.tsにHTTPS関連環境変数が未実装 | Confirmed |

## ステージ別結果

| Stage | レビュー種別 | 指摘数 | 対応数 | ステータス |
|-------|------------|-------|-------|----------|
| 0.5 | 仮説検証 | 8仮説 | 全確認 | ✅ |
| 1 | 通常レビュー（1回目） | 19件（Must 4） | - | ✅ |
| 2 | 指摘事項反映（1回目） | - | 18件 | ✅ |
| 3 | 影響範囲レビュー（1回目） | 17件（Must 4） | - | ✅ |
| 4 | 指摘事項反映（1回目） | - | 17件 | ✅ |
| 5 | 通常レビュー（2回目） | 9件（Must 0） | - | ✅ |
| 6 | 指摘事項反映（2回目） | - | 7件 | ✅ |
| 7 | 影響範囲レビュー（2回目） | 10件（Must 0） | - | ✅ |
| 8 | 指摘事項反映（2回目） | - | 10件 | ✅ |

## 統計

- **総指摘数**: 55件
- **対応完了**: 52件
- **スキップ**: 3件（セキュリティリスク/スコープ外として妥当）

## 主な改善点

1. **認証責務境界の明確化**: middleware.ts（HTTP）とws-server.ts（WebSocket）の独立した認証責務を設計方針に明記
2. **トークンデータフローの具体化**: CLI生成→CM_AUTH_TOKEN_HASH環境変数→server.ts→auth.tsの5段階フローを詳述
3. **DaemonManagerへの伝達フロー追加**: デーモンモード起動時の認証オプション伝達設計を追加
4. **変更対象ファイルの拡充**: tsconfig.server.json、src/i18n.ts、src/cli/utils/daemon.ts等の漏れを補完
5. **後方互換性保証の明記**: CM_AUTH_TOKEN_HASH未設定時の即時パススルー動作を設計方針に明示
6. **CLIオプション-環境変数マッピング表**: --auth/--cert/--key等と環境変数の対応を一元化
7. **middleware.ts除外パスリスト**: /login、/api/auth/*、/_next/等の完全リストを追加
8. **テスト計画の充実**: NextRequest/NextResponseモック方針を含む5カテゴリのテスト計画

## Issue差分サマリー

### 追加されたセクション
- トークンのCLI-サーバー間データフロー
- 認証の責務境界（テーブル形式）
- CLIオプションと環境変数マッピング表
- デーモンモード対応（実装タスク）
- AuthProviderの追加（React Context）
- 実装順序ガイダンス
- テスト計画（5カテゴリ）
- レビュー履歴（全ステージの指摘対応テーブル）

### 修正されたセクション
- 影響範囲テーブル（10件以上のファイル追加・変更内容詳細化）
- 設計方針（後方互換性保証、Cookieに格納する値、auth-expire有効期限管理）
- 受入条件（デーモンモード、テスト、認証状態API等を追加）

## 次のアクション

- [x] GitHubのIssue #331が更新されている
- [ ] 設計方針書の作成（/design-policy 331）
- [ ] 実装開始（/pm-auto-dev 331）

## 関連ファイル

- 元のIssue: `dev-reports/issue/331/issue-review/original-issue.json`
- 仮説検証: `dev-reports/issue/331/issue-review/hypothesis-verification.md`
- Stage 1結果: `dev-reports/issue/331/issue-review/stage1-review-result.json`
- Stage 3結果: `dev-reports/issue/331/issue-review/stage3-review-result.json`
- Stage 5結果: `dev-reports/issue/331/issue-review/stage5-review-result.json`
- Stage 7結果: `dev-reports/issue/331/issue-review/stage7-review-result.json`

---

*Generated by multi-stage-issue-review command*
